<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Student Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            background: #f0f0f0;
            color: #111;
            padding: 20px;
        }

        header {
            background: #128c7e;
            color: white;
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
        }

        .card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input,
        textarea,
        select {
            display: block;
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
        }

        .btn {
            cursor: pointer;
            border-radius: 6px;
            padding: 8px 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            margin: 4px;
        }

        .btn.primary {
            background: #25d366;
            color: white;
        }

        .btn.secondary {
            background: #075e54;
            color: white;
        }

        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            background: #fff;
        }

        .question {
            margin-top: 12px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fafafa;
        }
    </style>
</head>

<body>
    <header>üìö Student Panel</header>

    <div class="card">
        <h2>Enter Your Details</h2>
        <input id="studentName" placeholder="Your Name" />
        <input id="studentId" placeholder="Roll Number / ID" />
        <input id="testCode" placeholder="Test Code (optional)" />
        <button class="btn primary" onclick="loadTests()">Browse Available Tests</button>
        <button class="btn secondary" onclick="searchByCode()">Search by Code</button>
        <div id="loadError" style="color:red;"></div>
    </div>

    <div class="card">
        <h2>Available Tests</h2>
        <div id="testList"></div>
    </div>

    <div class="card" id="testSection" style="display:none;">
        <h2 id="testTitle"></h2>
        <p id="testDescription"></p>
        <div id="questionArea"></div>
        <button class="btn primary" onclick="submitAnswers()">Submit Answers</button>
        <div id="submitStatus"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBtyN8-Xl2EFdfRqXKvtTwbhlAu_oqDGaA",
            authDomain: "test-4d502.firebaseapp.com",
            projectId: "test-4d502",
            storageBucket: "test-4d502.appspot.com",
            messagingSenderId: "787828834403",
            appId: "1:787828834403:web:ba9791170e2b6c5f6df856"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentTest = null;

        async function loadTests() {
            const name = document.getElementById("studentName").value.trim();
            const sid = document.getElementById("studentId").value.trim();
            if (!name || !sid) {
                document.getElementById("loadError").textContent = "Please enter your name and ID.";
                return;
            }
            document.getElementById("loadError").textContent = "";
            const snap = await db.collection("tests").get();
            const container = document.getElementById("testList");
            container.innerHTML = "";

            for (const doc of snap.docs) {
                const t = doc.data();
                const id = doc.id;
                if (!t.published || t.resultsPublished) continue;
                if (t.validUntil && new Date(t.validUntil) < new Date()) continue;

                const existing = await db.collection("responses")
                    .where("testId", "==", id)
                    .where("studentId", "==", sid)
                    .get();
                const alreadyGiven = !existing.empty;

                const div = document.createElement("div");
                div.className = "test-card";
                div.innerHTML = `
          <h3>${t.title}</h3>
          <p><strong>Duration:</strong> ${t.duration} min</p>
          <p><strong>Questions:</strong> ${t.questions?.length || 0}</p>
          <p><strong>Total Marks:</strong> ${(t.questions || []).reduce((sum, q) => sum + (q.marks || 0), 0)}</p>
          <p><strong>Status:</strong> ${alreadyGiven ? "‚úÖ Already Given" : "üü¢ Not Yet Given"}</p>
          <button class="btn secondary" onclick="startTest('${id}')" ${alreadyGiven ? "disabled" : ""}>Start Test</button>
        `;
                container.appendChild(div);
            }
        }

        async function searchByCode() {
            const code = document.getElementById("testCode").value.trim();
            const name = document.getElementById("studentName").value.trim();
            const sid = document.getElementById("studentId").value.trim();
            if (!name || !sid || !code) {
                document.getElementById("loadError").textContent = "Please enter name, ID, and test code.";
                return;
            }
            document.getElementById("loadError").textContent = "";
            const doc = await db.collection("tests").doc(code).get();
            if (!doc.exists) {
                document.getElementById("loadError").textContent = "Test not found.";
                return;
            }
            const t = doc.data();
            if (!t.published || t.resultsPublished || (t.validUntil && new Date(t.validUntil) < new Date())) {
                document.getElementById("loadError").textContent = "Test is not available.";
                return;
            }
            startTest(code);
        }

        async function startTest(id) {
            const name = document.getElementById("studentName").value.trim();
            const sid = document.getElementById("studentId").value.trim();
            const existing = await db.collection("responses")
                .where("testId", "==", id)
                .where("studentId", "==", sid)
                .get();
            if (!existing.empty) {
                document.getElementById("loadError").textContent = "You have already submitted this test.";
                return;
            }

            const doc = await db.collection("tests").doc(id).get();
            const t = doc.data();
            currentTest = { id, ...t };
            document.getElementById("testTitle").textContent = t.title;
            document.getElementById("testDescription").textContent = t.description || "";
            const qArea = document.getElementById("questionArea");
            qArea.innerHTML = "";
            (t.questions || []).forEach((q, i) => {
                const div = document.createElement("div");
                div.className = "question";
                div.innerHTML = `<strong>Q${i + 1} (${q.marks} marks):</strong> ${q.text}<br>`;
                if (q.type === "mcq" && q.options) {
                    q.options.forEach(opt => {
                        div.innerHTML += `<label><input type="radio" name="q${i}" value="${opt}"> ${opt}</label><br>`;
                    });
                } else {
                    div.innerHTML += `<input type="text" name="q${i}" placeholder="Your answer" />`;
                }
                qArea.appendChild(div);
            });
            document.getElementById("testSection").style.display = "block";
            document.getElementById("testSection").scrollIntoView({ behavior: "smooth" });
        }

        async function submitAnswers() {
            const name = document.getElementById("studentName").value.trim();
            const sid = document.getElementById("studentId").value.trim();
            const answers = {};
            const qList = currentTest.questions || [];
            qList.forEach((q, i) => {
                const nameAttr = "q" + i;
                let val = "";
                if (q.type === "mcq") {
                    const selected = document.querySelector(`input[name="${nameAttr}"]:checked`);
                    val = selected ? selected.value : "";
                } else {
                    const input = document.querySelector(`input[name="${nameAttr}"]`);
                    val = input ? input.value.trim() : "";
                }
                answers[nameAttr] = val;
            });

            try {
                await db.collection("responses").add({
                    testId: currentTest.id,
                    studentName: name,
                    studentId: sid,
                    submittedAt: new Date().toISOString(),
                    answers
                });
                document.getElementById("submitStatus").textContent = "‚úÖ Answers submitted successfully!";
                document.getElementById("testSection").style.display = "none";
                document.getElementById("testList").scrollIntoView({ behavior: "smooth" });
            } catch (e) {
                document.getElementById("submitStatus").textContent = "‚ùå Error submitting answers: " + e.message;
            }
        }
    </script>
</body>

</html>